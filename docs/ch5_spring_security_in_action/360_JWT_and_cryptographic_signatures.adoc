== OAuth 2: Using JWT and cryptographic signatures

*Source code:*



*Content:*

- 1. Intro
- 2. Что такое токен. JWT - JSON Web Token
  * 2.1 Токены позволяют не отсылать креды юзера в каждом запросе
  * 2.2 Вы можете определить токены с коротким временем жизни
  * 2.3 Токены могут хранить дополнительные сведения
  * 2.4 Токены помогают делегировать ответственность за аутентификацию другому компоненту в системе
- 3. Что такое JSON Web Token?

=== 1. Intro

Использование криптографических подписей для проверки токенов позволяет _resource server_ проверять их без необходимости прямого вызова _authorization server_ и без использования общей базы данных. Этот подход к реализации проверки токена обычно используется в системах, реализующих аутентификацию и авторизацию с помощью OAuth 2.

=== 2. Что такое токен. JWT - JSON Web Token

Для веб-приложения токен — это строка, обычно отправляемая через HTTP-заголовок клиентами, которые хотят получить доступ к определенной конечной точке. Эта строка может быть простой как UUID или иметь более сложную форму, например JSON веб-токен (*_JWT_*).

На уровне реализации токены могут быть даже обычными строками. Однако нужно уметь распознавать их после того, как вы их выпустите. Вы можете генерировать UUID и хранить их в памяти или в базе данных. Рассмотрим следующий сценарий:

- 1. Клиент подтверждает свою личность серверу своими учетными данными.
- 2. Сервер выдает клиенту токен в формате UUID. Этот токен, теперь связанный с клиентом, сохраняется в памяти сервером:

image:img/jwt_server_returns_uuid_token_schema.png[]

- 3. Когда клиент вызывает конечную точку, клиент предоставляет токен и авторизуется:

image:img/jwt_client_provides_token_schema.png[]

Это сложнее, чем обычный вход в систему через _Basic auth_. Но токены дают больше преимуществ, поэтому давайте перечислим их, а затем обсудим каждый пункт:

- Токены позволяют не отсылать креды юзера в каждом запросе.
- Вы можете определить токены с коротким временем жизни.
- Вы можете аннулировать токены без аннулирования учетных данных.
- Токены могут хранить такие сведения, как полномочия пользователя, которые клиент должен отправить в запросе.
- Токены помогают делегировать ответственность за аутентификацию другому компоненту в системе.

==== 2.1 Токены позволяют не отсылать креды юзера в каждом запросе

Отправка учетных данных в каждом запросе - как в случае с _HTTP Basic_ - недопустима, потому что вы часто раскрываете их, поэтому больше шансов, что кто-то их перехватит. С токенами нам нужно отправить учетные данные только один раз, чтобы получить токен. После аутентификации мы отправляем в запросах только токен.

==== 2.2 Вы можете определить токены с коротким временем жизни

Вы можете определить токены с коротким временем жизни. Если мошенник украдет токен, он не сможет использовать его вечно. Скорее всего, срок действия токена может истечь до того, как они узнают, как использовать его для взлома вашей системы. Вы также можете аннулировать токены. Если вы обнаружите, что токен был раскрыт, вы можете опровергнуть это. Таким образом, он больше не может быть использован кем-либо.

==== 2.3 Токены могут хранить дополнительные сведения

Токены также могут хранить детали, необходимые в запросе. Мы можем использовать токены для хранения таких сведений, как полномочия и роли пользователя. Таким образом, мы можем заменить сеанс на стороне сервера сеансом на стороне клиента, что обеспечивает большую гибкость для горизонтального масштабирования.

==== 2.4 Токены помогают делегировать ответственность за аутентификацию другому компоненту в системе

Токены помогают вам реализовать отдельный микросервис для аутентификации. С этим микросервисом мы можем добавить любую систему, которая не управляет своими пользователями, а позволяет пользователям проходить аутентификацию, используя учетные данные из учетных записей, которые у них есть на других платформах, таких как GitHub и т. д.

=== 3. Что такое JSON Web Token?

В этом разделе мы обсудим более конкретную реализацию токенов — *_JSON web token (JWT)_*. Он использует JSON для форматирования содержащихся в нем данных. JWT состоит из трех частей, каждая часть отделена от других точкой (точкой). Например:
----
eyJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImRhbmllbGxlIn0.wg6LFProg7s_KvFxvnYGiZFMj4rr-0nJA1tVGZNn8U
----
Первые две части — *_заголовок_* и *_тело_*. Они форматируются в _JSON_, а затем кодируются _Base64_. Мы используем их для хранения _token details_. Так выглядят заголовок и тело до того, как они будут закодированы в Base64:
[source, json]
----
{
  "alg": "HS256"
}
----
[source, json]
----
{
  "username": "danielle"
}
----

image:img/jwt_decoded_token_example_on_jwt_io.png[]

В заголовке хранятся метаданные токена. В этом случае токен подписан, и заголовок содержит имя алгоритма, генерирующего подпись (_HS256_). В теле можно указать реквизиты, необходимые позже для авторизации. В этом случае у нас есть только имя пользователя. Рекомендуется делать токен как можно короче и не добавлять в него лишние данные:

- Если токен длинный, это замедляет запрос.
- При подписи токена, чем длиннее токен, тем больше времени требуется криптографическому алгоритму для его подписи.

Последняя часть токена — *_цифровая подпись_*, но эта часть может отсутствовать. Поскольку вы обычно предпочитаете подписывать заголовок и тело, когда вы подписываете содержимое токена, вы можете позже использовать подпись, чтобы убедиться, что содержимое не изменилось. Без подписи нельзя быть уверенным, что кто-то не перехватил токен при передаче по сети и не изменил его содержимое.

---
Смотри далее: link:360_JWT_and_cryptographic_signatures_part2.adoc[]